---
title: "PUBH 7462 Homework 2"
author: "Chris Wojan"
date: "2/10/2022"
output: github_document
---

### Problem 3.1
#### Data Exploration and Cleaning

Data exploration code is hidden, but data cleaning code is presented below:

```{r setup, include = FALSE}

## Load libraries
library(tidyverse)
library(DataExplorer)
library(janitor)
library(gt)

## Set knitr options
knitr::opts_chunk$set(echo = TRUE)

## Set Theme for ggplot2 - centers title and legend at bottom by default
theme_set(theme_bw() + 
          theme(plot.title = element_text(hjust = 0.5), legend.position = "bottom"))

## Set Scientific notation output and decimal places for knitr
options(scipen = 999)
options(digits = 4)
```

```{r 3.1_data_explore, include = FALSE}

## Read in BRFSS SMART County Prevalence data
brfss_data <- read_csv("./data/brfss_smart_2010.csv")

## Check some basic features of the data
introduce(brfss_data)
plot_intro(brfss_data)
plot_str(brfss_data)
plot_missing(brfss_data)
plot_histogram(brfss_data)

```

```{r 3.1_data_clean, echo = TRUE, results = FALSE}

### "Clean" the data

## Make column (variable) names consistent
brfss_clean <- clean_names(brfss_data) 

## Subset the data that we are interested in
brfss_clean <- brfss_clean %>%
  separate(col = locationdesc, into = c("state", "county"), sep = " - ") %>%
  filter(topic %in% "Overall Health") %>%
  select(year, state, county, response, sample_size, data_value) %>%
  rename(num_respondents = sample_size,
         percent = data_value)

## Check if column types need to be reformatted
str(brfss_clean)

## Format variables that represent categories as factors
## (I decided not to factorize "county" because county names may be shared across states,
## having FIPS would be better)
brfss_clean <- brfss_clean %>%
  mutate(
    state = factor(state),
    response = factor(response)
  )

## Check response level order
levels(brfss_clean$response)

## Reorder response levels by ordinal position
brfss_clean$response <- fct_relevel(brfss_clean$response, 
                                    c("Excellent", "Very good", "Good", "Fair", "Poor"))
  
```

### Problem 3.2
#### Data Description

This cleaned BRFSS SMART dataset represents information on the self-reported general health of survey particpants by state and county. It includes `r nrow(brfss_clean)` rows (or observations) and `r ncol(brfss_clean)` columns (or variables). Each observation represents a particular level of general health for a given state, county and year. The variables are as follows:

Variable                  | Description  
------------------------- | ------------------------------------------  
`r names(brfss_clean)[1]` | Year of survey
`r names(brfss_clean)[2]` | US state where survey was conducted
`r names(brfss_clean)[3]` | County where survey was conducted
`r names(brfss_clean)[4]` | Self-reported general health status (Excellent - Poor)
`r names(brfss_clean)[5]` | Number of respondents that reported this health status (#)
`r names(brfss_clean)[6]` | Proportion of respondent that reported this health status (%)

### Problem 3.3
#### 3.3.1

```{r prob_3.3.1, echo = TRUE}

## Create a subset of the data that represent county locations
brfss_331 <- brfss_clean %>%
  filter(year %in% 2004) %>%
  select(year, state, county) %>%
  distinct()

```

The following states featured 6 surveyed counties (or locations): `r names(which(summary(brfss_331$state) == 6))`

#### 3.3.2

```{r prob_3.3.2, echo = TRUE}

## Draw a plot of observed counties by year, spearated by state
brfss_clean %>%
  select(year, state, county) %>%
  distinct() %>%
  count(state, year, name = "counties") %>%
  mutate(state = fct_reorder(state, counties, .fun = mean, .desc = TRUE)) %>%
  ggplot() +
    geom_line(aes(x = year, y = counties, color = state)) +
    guides(color = guide_legend(title = "State", nrow = 3, byrow = TRUE)) +
    labs(x = "Year", y = "Number of Counties", title = "Number of Counties Observed by Year") +
    theme(legend.title = element_text(size = 10),
          legend.text = element_text(size = 7),
          legend.key.width = unit(2,"mm"),
          legend.key.height = unit(1, "mm"))

```

The state with the highest mean number of counties observed via survey is New Jersey, with Florida having the second highest. Overall the number of counties observed in each state seems to increase slightly over time. Florida exhibits a strange pattern where 40+ counties were observed in 2007 and 2010.

#### 3.3.3

```{r prob_3.3.3, echo = TRUE, message = FALSE}

## Create a gt table of summarized, select health responses for MN in select years
brfss_clean %>%
  filter(year %in% c(2002, 2006, 2010), state %in% "MN", 
         response %in% c("Excellent", "Good", "Poor")) %>%
  group_by(year, response) %>%
  summarize(mean_num = mean(num_respondents, na.rm = TRUE),
            sd_num = sd(num_respondents, na.rm = TRUE),
            mean_percent = mean(percent, na.rm = TRUE),
            sd_percent = sd(percent, na.rm = TRUE)) %>%
  gt() %>%
  tab_header("Summary of Selected Health Responses in MN (2002, 2006, & 2010)")

```
Overall, the three different years show fairly similar results for each response type. Across years, "Poor" responses comprise 2-2.5% of responses averaged across MN, while "Excellent" and "Good" each comprise about a quarter of responses. Finally, the proportion of "Excellent" responses appears to vary more widely from county to county in MN as compared to "Good and "Poor" responses, as evidenced by the consistently higher standard deviation observed.

### 3.3.4





